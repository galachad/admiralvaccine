---
title: "Creating ADFACE"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating ADFACE}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(admiral)
link <- function(text, url) {
  return(
    paste0(
      "[", text, "]",
      "(", url, ")"
    )
  )
}
dyn_link <- function(text,
                     base_url,
                     relative_url = "",
                     # Change to TRUE when admiral adopts multiversion docs
                     is_multiversion = FALSE,
                     multiversion_default_ref = "main") {
  url <- paste(base_url, relative_url, sep = "/")
  if (is_multiversion) {
    url <- paste(
      base_url,
      Sys.getenv("BRANCH_NAME", multiversion_default_ref),
      relative_url,
      sep = "/"
    )
  }
  return(link(text, url))
}
# Other variables
admiral_homepage <- "https://pharmaverse.github.io/admiral"
library(admiraldev)
```

# Introduction

This article describes creating an `ADFACE` ADaM with common vaccine
endpoint parameters based on CBER guidelines.

Examples are currently presented and tested using `ADSL` (ADaM) and
`face`, `vs` (SDTM) inputs. However, other domains could be used. 

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input
unless otherwise specified.*

# Programming Workflow

-   [Read in Data](#readdata)
-   [Pre-processing of Input Records](#input)
-   [Merge face with ex](#merge)
-   [Derive fever records from VS domain](#fever)
-   [Derive/Impute Numeric Date/Time and Analysis Day (`ADT`, `ADTM`, `ADY`, `ADTF`, `ATMF`)](#datetime)
-   [Derive direct mapping variables](#mapping)
-   [Derive severity records for Redness and swelling](#sev)
-   [Derive maximum severity records](#maxsev)
-   [Derive maximum diameter records](#maxdiam)
-   [Derive maximum temperature records](#maxtemp)
-   [Assign `PARAMCD`, `PARAM`, `PARAMN`, `PARCAT1`](#paramcd)
-   [Derive maximum severity flag](#maxflag)
-   [Derive event occurrence flag](#eventflag)
-   [Add ADSL variables](#adsl_vars)

## Read in Data {#readdata}

To start, all data frames needed for the creation of `ADFACE` should be read into
the environment.  This will be a company specific process.  Some of the 
data frames needed may be `EX` and `FACE`.

```{r message=FALSE}
library(admiral)
library(admiralvaccine)
library(dplyr, warn.conflicts = FALSE)
library(lubridate)
library(stringr)
library(tidyr)
library(tibble)
data("vx_face")
data("vx_ex")
data("vx_vs")

face <- convert_blanks_to_na(vx_face)
ex <- convert_blanks_to_na(vx_ex)
vs <- convert_blanks_to_na(vx_vs)
```

## Pre-processing of Input Records {#input}

This step involves company-specific pre-processing of required input records for
further analysis. In this step, we will filter records that has only reactogenicity events.

```{r echo=FALSE}
face <- face %>%
  filter(FACAT == "REACTOGENICITY" & grepl("ADMIN|SYS", FASCAT)) %>%
  mutate(FAOBJ = str_to_sentence(FAOBJ))
```

```{r, echo=FALSE}
dataset_vignette(
  face,
  display_vars = exprs(USUBJID, FAOBJ, FATESTCD, FACAT, FASCAT, FATPTREF, FADTC)
)
```

## Merge face with ex {#merge}

In this step, we will merge `face` with `ex ` domain and add required variables from the `ex` domain to the input dataset. If subjects have multiple vaccination at same visit then this function will not merge input dataset with `ex` dataset.

The function `derive_vars_merged_vaccine` is used to merge `face` with `ex` domain.

```{r eval=TRUE}
adface <- derive_vars_merged_vaccine(
  dataset = face,
  dataset_ex = ex,
  dataset_supp = NULL,
  dataset_suppex = NULL,
  ex_vars = exprs(EXTRT, EXDOSE, EXSEQ, EXSTDTC, EXENDTC, VISIT, VISITNUM)
)
```
  
```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, FATESTCD, FATPTREF)
)
```  

## Derive fever records from VS domain {#fever}

In this step, we will merge fever records with the input dataset from the `VS` domain if the fever records does not present in the input dataset.

The function `derive_param_fever_occur` is used to merge fever records. Fever records will be useful in the later case to calculate maximum temperature.

```{r eval=TRUE}
adface <- derive_param_fever_occur(
  dataset = adface,
  source_data = vs,
  faobj = "Fever"
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, FATESTCD, FAORRES, VSSTRESN, VSSTRESU),
  filter = FAOBJ == "Fever"
)
``` 

## Derive/Impute Numeric Date/Time and Analysis Day (`ADT`, `ADTM`, `ADY`, `ADTF`, `ATMF`) {#datetime}

The function `derive_vars_dt()` can be used to derive `ADT`. This function allows 
the user to impute the date as well.

Similarly, `ADTM` may be created using the function `derive_vars_dtm()`. 
Imputation may be done on both the date and time components of `ADTM`.

Example calls:

```{r eval=TRUE}
adface <- adface %>%
  derive_vars_dt(
    new_vars_prefix = "A",
    dtc = FADTC
  ) %>%
  derive_vars_dtm(
    new_vars_prefix = "A",
    dtc = FADTC,
    highest_imputation = "n"
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FATPTREF, FAOBJ, ADT, ADTM)
)
```

## Derive direct mapping variables {#mapping}

The mapping of these variables is left to the ADaM programmer. An 
example mapping may be:

```{r, echo=FALSE}
adface <- adface %>%
  mutate(
    AVAL = FAORRES,
    AVAL = as.numeric(AVAL),
    AVALC = as.character(FAORRES),
    ATPTREF = FATPTREF,
    ATPT = FATPT,
    ATPTN = FATPTNUM,
    # AVISIT = VISIT,
    # AVISITN = VISITNUM
  )
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, AVAL, AVALC, ATPTREF, ATPTN)
)
```


## Derive severity records for Redness and swelling{#sev}

The function `derive_param_diam_to_sev` is used to derive the severity records from the diameter records for an event.

The severity records created will be useful for calculating the maximum severity records.

```{r, echo=FALSE}
adface <- derive_param_diam_to_sev(
  dataset = adface,
  filter_diam = c("DIAMETER", "LDIAM"),
  filter_faobj = c("Redness", "Swelling", "Erythema"),
  testcd_sev = "SEV",
  test_sev = "Severity/Intensity",
  none = c(0, 2),
  mild = c(2, 5),
  mod = c(5, 10),
  sev = c(10)
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, FATESTCD, FATEST, AVAL, AVALC, DTYPE),
  filter = DTYPE == "DERIVED"
)
```

## Derive maximum severity records{#maxsev}

The function `derive_param_maxsev` is used to derive the maximum severity records for administration and systemic events.

```{r, echo=FALSE}
adface <- derive_param_maxsev(
  dataset = adface,
  exclude_events = NULL,
  filter_sev = "SEV",
  test_maxsev = "Maximum Severity",
  testcd_maxsev = "MAXSEV",
  by_vars = exprs(USUBJID, FAOBJ, ATPTREF)
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, FATESTCD, FATEST, AVAL, AVALC, DTYPE),
  filter = FATESTCD == "MAXSEV"
)
```

## Derive maximum diameter records{#maxdiam}

The function `derive_param_maxdiam` is used to derive the maximum diameter records for administration events.

The user is expected to filter `FATESTCD` variable based on events that has diameter.

```{r, echo=FALSE}
adface <- derive_param_maxdiam(
  dataset = adface,
  filter = FAOBJ %in% c("Redness", "Erythema") & FATESTCD %in% c("DIAMETER", "LDIAM"),
  by_vars = exprs(USUBJID, FAOBJ, FALNKGRP),
  test_maxdiam = "Maximum Diameter",
  testcd_maxdiam = "MAXDIAM"
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, FATESTCD, FATEST, AVAL, AVALC, DTYPE),
  filter = FATESTCD == "MAXDIAM"
)
```

## Derive maximum temperature records{#maxtemp}

The function `derive_param_maxtemp` is used to derive the maximum temperature records.

```{r, echo=FALSE}
adface <- derive_param_maxtemp(
  dataset = adface,
  filter_faobj = "Fever",
  test_maxtemp = "Maximum Temperature",
  testcd_maxtemp = "MAXTEMP",
  by_vars = exprs(USUBJID, FAOBJ, ATPTREF)
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, FATESTCD, FATEST, AVAL, AVALC, DTYPE),
  filter = FATESTCD == "MAXTEMP"
)
```

## Assign `PARAMCD`, `PARAM`, `PARAMN`, `PARCAT1` {#paramcd}

To assign parameter level values such as `PARAMCD`, `PARAM`, `PARAMN`, `PARCAT1`,
etc., a lookup can be created to join to the source data.

For example, when creating `ADFACE`, a lookup based on the SDTM `--TESTCD` value 
may be created:

`FATESTCD` | `PARAMCD` | `FATEST` | `FAOBJ` | `PARCAT1` | `PARCAT1N`
--------- | --------- | -------- | ------- | --------- | ----------
SEV | SEVREDN | Severity | Redness 
DIAMETER | DIARE | Diameter | Redness 
MAXDIAM | MDIRE | Maximum Diameter cm | Redness
MAXTEMP | MAXTEMP | Maximum Temperature | Fever
OCCUR | OCFEVER | Occurrence Indicator | Fever
OCCUR | OCERYTH | Occurrence Indicator | Erythema
SEV | SEVPAIN | Severity | Pain at Injection site
OCCUR | OCPAIN | Occurrence Indicator | Pain at Injection site
OCCUR | OCSWEL | Occurrence Indicator | Swelling

This lookup may now be joined to the source data:

```{r eval=TRUE, include=FALSE}
lookup_dataset <- tribble(
  ~FATESTCD,    ~PARAMCD,    ~FATEST,                ~FAOBJ,
  "SEV",        "SEVREDN",   "Severity",             "Redness",
  "DIAMETER",   "DIARE",     "Diameter",             "Redness",
  "MAXDIAM",    "MDIRE",     "Maximum Diameter cm",  "Redness",
  "MAXTEMP",    "MAXTEMP",   "Maximum Temperature",  "Fever",
  "OCCUR",      "OCFEVER",   "Occurrence Indicator", "Fever",
  "OCCUR",      "OCERYTH",   "Occurrence Indicator", "Erythema",
  "SEV",        "SEVPAIN",   "Severity",             "Pain at Injection site",
  "OCCUR",      "OCPAIN",    "Occurrence Indicator", "Pain at Injection site",
  "OCCUR",      "OCSWEL",    "Occurrence Indicator", "Swelling"
)
```

```{r, echo=FALSE}
adface <- derive_vars_params(
  dataset = adface,
  lookup_dataset = lookup_dataset
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, FATEST, PARAMCD, PARAM, PARAMN)
)
```

## Derive maximum severity flag{#maxflag}

The function `derive_vars_max_flag` is used to derive flag variable for the maximum values for an event.

```{r, echo=FALSE}
adface <- derive_vars_max_flag(
  dataset = adface,
  flag1 = "ANL01FL",
  flag2 = "ANL02FL"
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, AVAL, AVALC, ANL01FL, ANL02FL)
)
```

## Derive event occurrence flag{#eventflag}

The function `derive_vars_event_flag` is used to derive flag variable for the event occurred.

```{r, echo=FALSE}
adface <- derive_vars_event_flag(
  dataset = adface,
  by_vars = exprs(USUBJID, FAOBJ, ATPTREF),
  aval_cutoff = 2.5,
  new_var1 = EVENTFL,
  new_var2 = EVENTDFL
)
```

```{r, echo=FALSE}
dataset_vignette(
  adface,
  display_vars = exprs(USUBJID, FAOBJ, ATPTREF, AVAL, AVALC, EVENTFL, EVENTDFL, DTYPE)
)
```
